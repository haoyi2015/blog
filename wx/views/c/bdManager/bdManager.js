var vm_manager=avalon.define({$id:"vm_manager",wxOpenId:"",dialogStatus:!1,isconfirm:!1,ischecked:!1,isRed:!1,isselected:!1,dataNothing:!1,inns:[],financeList:[],inn:{innId:"",innName:"",appKey:""},indexs:{defindex:0,index:0},bankInfo:{bankAccount:"",bankType:"",bankCode:"",bankName:"",bankRegion:""},bdhotel:!1,hawInnId:!1,uris:{isBillRelation:"/api/wx/bound/relation/",financeList:"/api/finance/billList",financeConfirm:"/api/finance/billConfirm",BaseInfo:"/api/client/getBaseInfo/"},getOpenId:function(){var n=tmsky.util.urlParams(),e=n.code,a=n.wxOpenId;a?(vm_manager.wxOpenId=a,vm_manager.getInn()):(tmsky.ui.dialog.loading("身份验证中，请稍等。。。"),$.ajax({type:"GET",url:DOMAIN.API+"/api/wx/openId/"+e+"/MP4INN",error:function(n){tmsky.ui.dialog.alert(n)},success:function(n){if(!n.openid){if(tmsky.ui.dialog.loading.close(),window.localStorage){var e=window.localStorage.getItem("openId");if(e)return vm_manager.wxOpenId=e,void vm_manager.getInn()}return void tmsky.ui.dialog.tips("微信认证失败","error")}vm_manager.wxOpenId=n.openid,vm_manager.getInn(),window.localStorage&&window.localStorage.setItem("openId",n.openid),tmsky.ui.dialog.loading.close()}}))},getInn:function(){var n=tmsky.util.urlParams().hotelInnId,e=tmsky.util.timestampUrl(CONST.DOMAIN.ONLINE.API+vm_manager.uris.isBillRelation+vm_manager.wxOpenId);$.get(e).done(function(e){if(200==e.status){if(e.result.length){var a=vm_manager.getCookie("hotelInnId");tmsky.isEmpty(a)||(n=a),vm_manager.inns=e.result;var i=0,t="";return e.result.forEach(function(e,a){e.innId==n&&(vm_manager.inn=e,t=e,vm_manager.indexs={defindex:a,index:a},i++)}),0==i&&(vm_manager.inn=e.result[0],t=e.result[0]),vm_manager.dataNothing=!1,vm_manager.bdOpen(t.innId),vm_manager.bdhotel=!0,void((parseInt(n)==parseInt(22490)||parseInt(n)==parseInt(51481))&&(vm_manager.hawInnId=!0))}return void tmsky.ui.dialog.alert({title:"提示信息",content:"您暂时还未绑定客栈！",okText:"现在去绑定",cancelText:"不想绑定",ok:function(){window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxadddf1f97bc31bf1&redirect_uri=http://micro.fanqielaile.net&response_type=code&scope=snsapi_base&state=123#wechat_redirect"},cancel:function(){return!0}})}}).always(function(){tmsky.ui.dialog.loading.close()})},todialog:function(){vm_manager.dialogStatus=!0,$(".bill-dialog").css({display:"-webkit-box"})},getThisInn:function(n){vm_manager.indexs.defindex=n},dialogCancel:function(){$(".bill-dialog").hide(),vm_manager.indexs.defindex=vm_manager.indexs.index},dialogSure:function(){vm_manager.dialogStatus=!1,vm_manager.dataNothing=!1,vm_manager.indexs.index=vm_manager.indexs.defindex,vm_manager.inn=vm_manager.$model.inns[vm_manager.indexs.index],vm_manager.setCookie("hotelInnId",vm_manager.inn.innId,1)},bdInfo:{},bdOpen:function(n){var e={pmsInnId:n};0!=$(".managerCon").length&&$.ajax({type:"POST",url:DOMAIN.CRM+"/api/pms/getBDInfo",dataType:"json",data:e,success:function(n){200!=n.status||tmsky.isEmpty(n.data)?200==n.status&&tmsky.isEmpty(n.data)&&(vm_manager.bdInfo={}):vm_manager.bdInfo=n.data},error:function(){}})},orderClick:function(){vm_manager.inn.$model;location.href="roomManage.html"+location.search+"&wxOpenId="+vm_manager.wxOpenId+"&hotelInnId="+vm_manager.inn.innId},acountClick:function(){location.href="bill.html"+location.search+"&wxOpenId="+vm_manager.wxOpenId+"&hotelInnId="+vm_manager.inn.innId},managerClick:function(){location.href="bgManager.html"+location.search+"&wxOpenId="+vm_manager.wxOpenId+"&hotelInnId="+vm_manager.inn.innId},hawClick:function(){location.href="Hawkeye/index.html?"+location.search+"&wxOpenId="+vm_manager.wxOpenId+"&hotelInnId="+vm_manager.inn.innId},setCookie:function(n,e,a){var i=new Date;i.setDate(i.getDate()+a),document.cookie=n+"="+e+";expires="+i.toGMTString()},getCookie:function(n){for(var e=document.cookie.split("; "),a=0;a<e.length;a++)if(e[a].split("=")[0]==n)return e[a].split("=")[1];return""},removeCookie:function(n){setCookie(n,1,-1)}});avalon.ready(function(){var n=tmsky.util.urlParams();"skip"==n.skipOpenId?(vm_manager.wxOpenId=n.openId||"ogyI_t4JuZspa5cK5pQNX-zQl6vk",vm_manager.getInn()):vm_manager.getOpenId()});