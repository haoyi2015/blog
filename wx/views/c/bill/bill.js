var vm_bill=avalon.define({$id:"vm_bill",wxOpenId:"",dialogStatus:!1,isconfirm:!1,ischecked:!1,isRed:!1,isselected:!1,dataNothing:!1,inns:[],financeList:[],inn:{innId:"",innName:"",appKey:""},indexs:{defindex:0,index:0},bankInfo:{bankAccount:"",bankType:"",bankCode:"",bankName:"",bankRegion:""},uris:{isBillRelation:"/api/wx/bound/relation/",financeList:"/api/finance/billList",financeConfirm:"/api/finance/billConfirm",BaseInfo:"/api/client/getBaseInfo/"},getOpenId:function(){var n=tmsky.util.urlParams(),i=n.code,e=n.wxOpenId;e?(vm_bill.wxOpenId=e,vm_bill.getInn()):(tmsky.ui.dialog.loading("身份验证中，请稍等。。。"),$.get(DOMAIN.API+"/api/wx/openId/"+i+"/MP4INN").done(function(n){return n.openid?(vm_bill.wxOpenId=n.openid,void vm_bill.getInn()):(tmsky.ui.dialog.loading.close(),void tmsky.ui.dialog.tips("微信认证失败","error"))}))},getInn:function(){var n=tmsky.util.urlParams().hotelInnId,i=tmsky.util.timestampUrl(CONST.DOMAIN.ONLINE.API+vm_bill.uris.isBillRelation+vm_bill.wxOpenId);$.get(i).done(function(i){if(200==i.status){if(i.result.length){vm_bill.inns=i.result;var e=0;return i.result.forEach(function(i){i.innId==n&&(vm_bill.inn=i,e++)}),0==e&&(vm_bill.inn=i.result[0]),vm_bill.getFinanceList(),vm_bill.getBaseInfo(),void(vm_bill.dataNothing=!1)}return void tmsky.ui.dialog.alert({title:"提示信息",content:"您暂时还未绑定客栈！",okText:"现在去绑定",cancelText:"不想绑定",ok:function(){window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxadddf1f97bc31bf1&redirect_uri=http://micro.fanqielaile.net&response_type=code&scope=snsapi_base&state=123#wechat_redirect"},cancel:function(){return!0}})}}).always(function(){tmsky.ui.dialog.loading.close()})},getFinanceList:function(){var n={appKey:vm_bill.inn.appKey,innId:vm_bill.inn.innId,pageNo:1,pageSize:10},i=tmsky.util.timestampUrl(DOMAIN.FQMS+vm_bill.uris.financeList);$.post(i,n).done(function(n){return 200==n.status?n.result.billList.length?void(vm_bill.financeList=n.result.billList):(vm_bill.dataNothing=!0,void(vm_bill.financeList=[])):void 0})},getBaseInfo:function(){var n=tmsky.util.timestampUrl(DOMAIN.PMS+vm_bill.uris.BaseInfo+vm_bill.inn.innId);$.get(n).done(function(n){if(200==n.status){vm_bill.bankInfo.bankAccount=n.innAdmin.inn.bankAccount;var i=n.innAdmin.inn.bankCode;null!==i&&(vm_bill.bankInfo.bankCode=i.replace(/[\s]/g,"").replace(/(\d{4})(?=\d)/g,"$1 ")),vm_bill.bankInfo.bankName=n.innAdmin.inn.bankName,vm_bill.bankInfo.bankRegion=n.innAdmin.inn.bankRegion,vm_bill.bankInfo.bankType=n.innAdmin.inn.bankType,vm_bill.bankInfo.bankType="1"==n.innAdmin.inn.bankType?"个人":"公司"}})},getConfirm:function(n){var i={appKey:vm_bill.inn.appKey,innId:vm_bill.inn.innId,settlementTime:n},e=tmsky.util.timestampUrl(DOMAIN.FQMS+vm_bill.uris.financeConfirm);$.post(e,i).done(function(n){200==n.status&&(tmsky.ui.dialog.loading.close(),tmsky.ui.dialog.tips(n.message,"success"),vm_bill.getFinanceList())})},getThisInn:function(n){vm_bill.indexs.defindex=n},dialogCancel:function(){$(".bill-dialog").hide(),vm_bill.indexs.defindex=vm_bill.indexs.index},dialogSure:function(){vm_bill.dialogStatus=!1,vm_bill.dataNothing=!1,vm_bill.indexs.index=vm_bill.indexs.defindex,vm_bill.inn=vm_bill.$model.inns[vm_bill.indexs.index],vm_bill.getFinanceList(),vm_bill.getBaseInfo()}});avalon.ready(function(){var n=tmsky.util.urlParams();"skip"==n.skipOpenId?(vm_bill.wxOpenId=n.openId||"ogyI_t4JuZspa5cK5pQNX-zQl6vk",vm_bill.getInn()):vm_bill.getOpenId()});