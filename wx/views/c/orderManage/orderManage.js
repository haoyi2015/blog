var vm_order=avalon.define({$id:"vm_order",wxOpenId:"",refuseReasonList:{list:["请选择拒单原因","全部满房","到店时间过晚","价格不符","需要担保","特殊要求无法满足","重复订单","其他原因","酒店装修/停业","部分满房"],id:[0,3,4,5,6,7,8,9,20,24],selected:0},bool:{refuse:!1,handleBook:!1,rooms:!1,toApp:!1},allOrder:!1,ordersList:[],socketData:{},refuseId:"",activeOrder:{},allOrders:[],allOrderPageNo:1,allPages:1,clickForMore:function(){var e=vm_order.allOrderPageNo;return e++,e>vm_order.allPages?void tmsky.ui.dialog.alert("没有更多了！"):void vm_order.initAllOrders(e)},initAllOrders:function(e){tmsky.ui.dialog.loading();var r={dataResponseType:"API",checkInFrom:tmsky.date.plusDate(tmsky.date.today(),-30,"d","yyyy-MM-dd"),checkInTo:tmsky.date.today(),searchType:"CHECK_IN_AT",orderFlag:"ALL",orderStatus:10,pageNo:e||vm_order.allOrderPageNo,pageSize:20,innId:vm_order.secure.innId,userCode:vm_order.secure.userCode,appId:vm_order.secure.appId,timestamp:vm_order.secure.timestamp,token:vm_order.secure.token};$.ajax({type:"POST",url:DOMAIN.PMS+"/inn/orders/query",contentType:"application/json;charset=utf-8",data:JSON.stringify(r),error:function(){tmsky.ui.dialog.loading.close(),tmsky.ui.dialog.tips("网络错误！","error")},success:function(e){if(tmsky.ui.dialog.loading.close(),200==e.status){if(0==e.result.orders.length)return void(vm_order.allOrder=[]);if(vm_order.allPages=e.result.pages,OrderSortHandler.configByOrderFlag(r.orderFlag,r.searchType).sort(e.result.orders),0!=r.pageNo){var o=vm_order.allOrders;vm_order.allOrders=o.concat(e.result.orders)}else vm_order.allOrders=e.result.orders;vm_order.allOrderPageNo=r.pageNo}else tmsky.ui.dialog.tips(e.message,"error")}})},changeTabTo:function(e){vm_order.allOrder=e},alertToApp:function(e){vm_order.bool.toApp=e},openRefuse:function(e){vm_order.refuseId=e.id,107==e.otaId?vm_order.bool.refuse=!0:(vm_order.bool.refuse=!1,""!=vm_order.refuseId&&vm_order.ajaxOperateReceiveOrder("","refuse",vm_order.refuseId))},closeRefuse:function(){vm_order.bool.refuse=!1,vm_order.reset()},sureRefuse:function(){if(0==vm_order.refuseReasonList.selected)return tmsky.ui.dialog.tips("请选择拒单原因！","error"),!1;if(vm_order.bool.refuse=!1,""!=vm_order.refuseId){var e=vm_order.refuseReasonList.selected;vm_order.ajaxOperateReceiveOrder("","refuse",vm_order.refuseId,e)}},reset:function(){vm_order.bool={refuse:!1,handleBook:!1,rooms:!1,toApp:!1},vm_order.refuseReasonList.selected=0},checkInToday:function(e){return e.checkInAt==tmsky.date.today?!0:!1},getShortDate:function(e){return e?e.slice(5,10):void 0},receiveOrders:function(e){var r=function(){vm_order.getRooms(e)};e.autoBook?vm_order.ajaxOperateReceiveOrder(e,"confirm",e.id,"","","","handleConfirmAutoBook"):vm_order.ajaxOperateReceiveOrder(e,"confirm",e.id,"","",r)},bookOrder:function(e){vm_order.getRooms(e)},sureBookRoom:function(){for(var e,r=vm_order.convertBookData(),o=r.roomId,d=[],t=[],s={},i=0;null!=(e=o[i]);i++)s[e]?d.push(r.roomName[i]):(t.push(e),s[e]=!0);if(d=vm_order.arrayqc(d),0!=d.length)return tmsky.ui.dialog.alert("房间"+d.join(",")+"重叠，请选择不同房间！"),!1;o=t.join(",");var a=vm_order.activeOrder.id;tmsky.ui.dialog.loading(),vm_order.ajaxOperateReceiveOrder("","book",a,"",o)},convertBookData:function(){var e=[],r=[],o=vm_order.selectRoom.$model;return o.forEach(function(o){e.push(o.rooms[o.roomIndex].id),r.push(o.rooms[o.roomIndex].name)}),{roomId:e,roomName:r}},initGetOrders:function(e){if(e.receiveOmsOrders){var r=[];e=e.receiveOmsOrders,e.forEach(function(e){(e.needConfirm||!e.autoBook)&&r.push(e)}),vm_order.ordersList=r}},arrayqc:function(e){for(var r={},o=[],d=0;d<e.length;d++)r[e[d]]||(r[e[d]]=!0,o.push(e[d]));return o},selectRoom:[],roomList:[],getRooms:function(e){var r=[];e.orders.forEach(function(e){e.roomIds?r.push(e.roomIds.split(",")):""}),r.length>0?(r=vm_order.arrayqc(r),r=r.join(",")):r=0,tmsky.ui.dialog.loading();var o=DOMAIN.PMS+"/index/bookValidRoom/"+r+"/"+e.checkInAt+"/"+e.checkOutAt;2!=e.operateType||tmsky.isEmpty(e.fqOrderNo)||(o+="/"+e.fqOrderNo),$.get(o,vm_order.secure.$model).done(function(r){if(tmsky.ui.dialog.loading.close(),200===r.status){var o=$.extend(!0,[],r.bookValidRoomInfos);if(0==o.length)return tmsky.ui.dialog.tips("没有可分房型！","error"),!1;var d=[],t=[];if(o.forEach(function(e,r){e.rooms.forEach(function(o,t){o.roomIndex=t,o.roomTypeName=e.name,o.roomTypeIndex=r,d.push(o)})}),d.length<Number(e.roomTypeNum))return tmsky.ui.dialog.tips("没有可分房型！","error"),!1;vm_order.bool.handleBook=!0,vm_order.activeOrder=$.extend(!0,{},e);for(var s=0;s<=Number(e.roomTypeNum)-1;s++){var i=d[s].roomTypeIndex,a={typeIndex:i,roomIndex:d[s].roomIndex,rooms:$.extend(!0,[],r.bookValidRoomInfos)[i].rooms};t.push(a)}vm_order.selectRoom=t,vm_order.roomList=$.extend(!0,[],r.bookValidRoomInfos)}}).error(function(){tmsky.ui.dialog.loading.close(),tmsky.ui.dialog.alert("查询房间失败，请检查网络情况！")})},changeRoomType:function(e){{var r=$.extend(!0,[],vm_order.roomList.$model);vm_order.selectRoom.$model}e.rooms=r[e.typeIndex].rooms,e.roomIndex=0},getOpenId:function(){var e=tmsky.util.urlParams(),r=e.code,o=e.wxOpenId;o?(vm_order.wxOpenId=o,vm_order.getInn()):(tmsky.ui.dialog.loading("身份验证中，请稍等。。。"),$.get(DOMAIN.API+"/api/wx/openId/"+r+"/MP4INN").done(function(e){if(!e.openid){if(tmsky.ui.dialog.loading.close(),window.localStorage){var r=window.localStorage.getItem("openId");if(r)return vm_order.wxOpenId=r,void vm_order.getInn()}return void tmsky.ui.dialog.tips("微信认证失败","error")}vm_order.wxOpenId=e.openid,vm_order.getInn(),window.localStorage&&window.localStorage.setItem("openId",e.openid),tmsky.ui.dialog.loading.close()}))},handleLater:function(){vm_order.reset()},getInn:function(){tmsky.util.urlParams().hotelInnId;vm_order.getSafeInfo(),vm_order.initHandleOrders(vm_order.secure.$model),vm_order.initAllOrders()},ajaxOperateReceiveOrder:function(e,r,o,d,t,s,i){var a={operateType:r,imsId:o,innId:vm_order.secure.innId,userCode:vm_order.secure.userCode,appId:vm_order.secure.appId,timestamp:vm_order.secure.timestamp,token:vm_order.secure.token};""!=d&&void 0!=d&&(a.refuseType=d),""!=t&&void 0!=t&&(a.roomIds=t),$.ajax({type:"POST",url:DOMAIN.PMS+"/ims/operateReceiveOrder",dataType:"json",data:a,success:function(d){if(200==d.status){switch(r){case"book":tmsky.ui.dialog.loading.close(),vm_order.deleteOrder(o),vm_order.reset(),tmsky.ui.dialog.tips("分房成功！","success");break;case"refuse":vm_order.deleteOrder(o),vm_order.reset(),tmsky.ui.dialog.tips("拒绝成功！","success");break;case"confirm":tmsky.isEmpty(i)||"handleConfirmAutoBook"!=i?(e.needConfirm=!1,tmsky.ui.dialog.tips("确认成功！","success")):(tmsky.ui.dialog.tips("确认并分房成功！","success"),vm_order.deleteOrder(o))}"function"==typeof s&&s()}else tmsky.ui.dialog.loading.close(),tmsky.ui.dialog.tips(d.message,"error")},error:function(){tmsky.ui.dialog.loading.close(),tmsky.ui.dialog.tips("网络错误","error")}})},deleteOrder:function(e){var r=vm_order.ordersList;r.forEach(function(o,d){o.id==e&&avalon.Array.removeAt(r,d)}),vm_order.ordersList=r},uris:{isBillRelation:"/api/wx/bound/relation/"},secure:{userCode:"momo",innId:141,appId:"Lk6UusE0",timestamp:1474961208282,token:"AE4E213ED2EDE2AD6CF8C00DC420B1FB87A0823525693659A0EBA15520742FB1659EAAFBFCC0140D549A8E130E295781"},getSafeInfo:function(){var e=tmsky.util.urlParams().hotelInnId,r=tmsky.util.timestampUrl(CONST.DOMAIN.ONLINE.API+vm_order.uris.isBillRelation+vm_order.wxOpenId);$.ajax({type:"get",url:r,async:!1,success:function(r){tmsky.ui.dialog.loading.close(),200==r.status&&r.result.length&&r.result.forEach(function(r){if(r.innId==e){var o={};tmsky.isEmpty(r.secure)||(o=r.secure,vm_order.secure={userCode:o.userCode,appId:o.appId,timestamp:o.timestamp,innId:e,token:o.token})}})},error:function(){tmsky.ui.dialog.tips("获取客栈安全信息错误！","error"),tmsky.ui.dialog.loading.close()}})},initHandleOrders:function(e){$.ajax({type:"GET",url:DOMAIN.PMS+"/inns/all/poll?tmp="+(new Date).getMilliseconds(),dataType:"json",data:e,success:function(e){200==e.status?(avalon.vmodels.vm_order.socketData=e,avalon.vmodels.vm_order.initGetOrders(e)):tmsky.ui.dialog.tips("获取订单信息错误！","error")}})}});avalon.ready(function(){var e=tmsky.util.urlParams();"skip"==e.skipOpenId?(vm_order.wxOpenId=e.openId||"ogyI_t4JuZspa5cK5pQNX-zQl6vk",vm_order.getInn()):vm_order.getOpenId()});