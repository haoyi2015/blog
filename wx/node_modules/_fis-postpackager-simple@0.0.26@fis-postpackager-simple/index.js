"use strict";function trimQuery(e){return-1!==e.indexOf("?")&&(e=e.slice(0,e.indexOf("?"))),e}function wrapTag(e){return"string"==typeof e?new RegExp(fis.util.escapeReg(e)):(fis.util.is(e,"RegExp")||fis.log.error("invalid regexp ["+e+"]"),e)}function analyzeHtml(e,t,i){var r,a=/(<script(?:(?=\s)[\s\S]*?["'\s\w\/\-]>|>))([\s\S]*?)(?:<\/script\s*>)\s*|<(link)\s+[\s\S]*?["'\s\w\/]>\s*|<!--([\s\S]*?)-->\s*/gi,n={scripts:[],inlineScripts:[],styles:[]},s=e.replace(a,function(e,a,s,c,o){var u=null,p=null;if(a){if(/(\sdata-fixed\s*=\s*)('true'|"true")/gi.test(a))return e;var l=/(\sdata-position\s*=\s*)('head'|"head")/gi.test(a);if(p=a.match(/(?:\ssrc\s*=\s*)(?:'([^']+)'|"([^"]+)"|[^\s\/>]+)/i),!p||!p[1]&&!p[2]){if(i)return e;var f=a.match(/type=(".*?"|'.*?')/i);return f=f&&f[1],f&&-1==f.indexOf("javascript")?e:(n.inlineScripts.push({content:e,head:l}),"")}var d=trimQuery(p[1]||p[2]);if(!t[d])return e;r=/(\sdata-single\s*=\s*)('true'|"true")/gi.test(a),u=t[d],n.scripts.push({content:e,id:u,single:r,head:l})}else if(c){var g=!1;if(p=e.match(/\srel\s*=\s*('[^']+'|"[^"]+"|[^\s\/>]+)/i),p&&p[1]){var h=p[1].replace(/^['"]|['"]$/g,"").toLowerCase();g="stylesheet"===h}if(!g)return e;if(/(\sdata-fixed\s*=\s*)('true'|"true")/gi.test(e))return e;if(p=e.match(/(?:\shref\s*=\s*)(?:'([^']+)'|"([^"]+)"|[^\s\/>]+)/i),p&&(p[1]||p[2])){var m=trimQuery(p[1]||p[2]);if(!t[m])return e;r=/(\sdata-single\s*=\s*)('true'|"true")/gi.test(e),u=t[m],n.styles.push({content:e,id:u,single:r})}}else if(o)return e;var k="<!--RESOURCE_"+u+"_PLACEHOLDER-->";return placeHolders[u]=k,i?k:""});return{resources:n,content:s}}function getResourcePathMap(e,t,i,r){var a={};return fis.util.map(e.map.res,function(e,t){a[trimQuery(t.uri)]=e}),fis.util.map(e.pkg,function(e,t){a[trimQuery(t.getUrl(r.hash,r.domain))]=t.getId()}),a}function getPackMap(e,t,i,r){var a={},n={},s={};return fis.util.map(e.map.pkg,function(e,t){a[t.uri]=e}),fis.util.map(e.pkg,function(t,i){var c=i.getUrl(r.hash,r.domain),o=a[c];o&&(s[o]=i,n[i.getId()]={id:o,pkg:e.map.pkg[o]})}),{packToFile:s,fileToPack:n}}function getPkgResource(e,t,i){function r(e){if(!i)return!0;var r=t.map.pkg[t.map.res[e.id].pkg],a=r.has.filter(function(e){return-1==o.indexOf(e)});return 0===a.length}function a(e,t,i){if(!n[e]){var r=!1;t.has.forEach(function(e){c[e]=!0,u[e]&&(r=r||u[e].head||!1)}),n[e]=!0,s.push({type:"pkg",id:e,srcId:i,head:r})}}var n={},s=[],c={},o=e.map(function(e){return e.id}),u={};return e.forEach(function(e){u[e.id]=e}),e.forEach(function(e){var i=e.id;if(c[i])return!1;if(t.packMap.fileToPack[i]){var n=t.packMap.fileToPack[i];return a(n.id,n.pkg,i),!0}var o=t.map.res[i];c[i]=!0,o.pkg&&r(e)?a(o.pkg,t.map.pkg[o.pkg],i):s.push({type:"res",id:i,single:e.single,head:e.head})}),s}function autoCombine(e,t,i,r,a){function n(e){var t=e.map(function(e){return e.id});return stable(t).join(",")}function s(){if(1==u.length)return o.push(u[0]),void(u=[]);if(0!==u.length){var e,i=n(u),s="",p=0,l=[];if(combineCache[i])fis.log.debug("auto combine hit cache ["+i+"]"),e=combineCache[i];else{u.forEach(function(e){var i=t.ids[e.id],r=i.getContent();l.push(i.getId()),c||(c=i.isJsLike?"js":"css"),""!==r&&(p++>0&&(s+="\n",i.isJsLike?s+=";":i.isCssLike&&(r=r.replace(/@charset\s+(?:'[^']*'|"[^"]*"|\S*);?/gi,""))),s+=r)});var f=r.output.replace("${index}",combineCount).replace("${hash}",fis.util.md5(stable(l).join(","),5))+"."+c,d=fis.file(fis.project.getProjectPath(),f);t.pkg[d.subpath]=d,d.setContent(s),e="auto_"+c+"_"+combineCount,t.map.pkg[e]={uri:d.getUrl(a.hash,a.domain),type:c,has:l},combineCache[i]=e,combineCount++}o.push({type:"pkg",id:e}),u=[]}}var c,o=[],u=[];return e.forEach(function(e){"pkg"===e.type?(s(),o.push(e)):e.single?(s(),o.push(e)):u.push(e)}),s(),o}function getCharset(e){var t=e?e.charset:fis.config.get("project.charset");switch(t){case"utf8":return"utf-8";default:return t}}function injectJs(e,t,i,r){var a="",n="";return e.forEach(function(e){var t,r;"pkg"===e.type?(t=i.map.pkg[e.id].uri,r=i.packMap.packToFile[e.id]):(t=i.map.res[e.id].uri,r=i.src[e.id]);var s='<script type="text/javascript" charset="'+getCharset(r)+'" src="'+t+'"></script>\n';e.head?n+=s:a+=s}),t=modBodyContent(t,a,r),t=modHeadContent(t,n,r)}function injectCss(e,t,i,r){var a="";return e.forEach(function(e){var t;t="pkg"===e.type?i.map.pkg[e.id].uri:i.map.res[e.id].uri,a+='<link type="text/css" rel="stylesheet" href="'+t+'">\n'}),t=modHeadContent(t,a,r)}function injectInlineJs(e,t,i,r){var a="",n="";return e.forEach(function(e){e.head?n+=e.content:a+=e.content}),t=modBodyContent(t,a,r),t=modHeadContent(t,n,r)}function modHeadContent(e,t,i){return i.headTag.test(e)?e=e.replace(i.headTag,t+"$&"):i.forceOutput&&(e=t+e),e}function modBodyContent(e,t,i){return i.bodyTag.test(e)?e=e.replace(i.bodyTag,t+"$&"):i.forceOutput&&(e+=t),e}function injectJsWithPlaceHolder(e,t,i){return e.forEach(function(e){var r,a,n;"pkg"===e.type?(r=i.map.pkg[e.id].uri,n=i.packMap.packToFile[e.id],a=e.srcId):(r=i.map.res[e.id].uri,n=i.src[e.id],a=e.id);var s='<script type="text/javascript" charset="'+getCharset(n)+'" src="'+r+'"></script>\n';t=t.replace(placeHolders[a],s),placeHolders[a]=!1}),t}function injectCssWithPlaceHolder(e,t,i){return e.forEach(function(e){var r,a;"pkg"===e.type?(r=i.map.pkg[e.id].uri,a=e.srcId):(r=i.map.res[e.id].uri,a=e.id);var n='<link type="text/css" rel="stylesheet" href="'+r+'">\n';t=t.replace(placeHolders[a],n),placeHolders[a]=!1}),t}function cleanPlaceHolder(e){return fis.util.map(placeHolders,function(t,i){i&&(e=e.replace(i,"")),placeHolders[t]=!1}),e}var combineCount=0,combineCache={},stable=require("stable"),defaultSetting={autoCombine:!1,autoReflow:!1,fullPackHit:{js:!1,css:!1},headTag:"</head>",bodyTag:"</body>",output:"pkg/auto_combine_${hash}"},placeHolders={};module.exports=function(e,t,i,r){if(r.pack){combineCache={},combineCount=0,i=fis.util.merge(fis.util.clone(defaultSetting),i),i.headTag=wrapTag(i.headTag),i.bodyTag=wrapTag(i.bodyTag);var a=getResourcePathMap(e,t,i,r);e.packMap=getPackMap(e,t,i,r),i.autoCombine&&(i.autoReflow=!0),fis.util.map(e.src,function(n,s){if(s.useCompile&&s.isHtmlLike&&s.noMapJs!==!1){placeHolders={};var c=s.getContent(),o=analyzeHtml(c,a,!i.autoReflow);c=o.content;var u=getPkgResource(o.resources.scripts,e,i.fullPackHit.js),p=getPkgResource(o.resources.styles,e,i.fullPackHit.css);i.autoCombine&&(u=autoCombine(u,e,t,i,r),p=autoCombine(p,e,t,i,r)),i.autoReflow?(c=injectJs(u,c,e,i),c=injectCss(p,c,e,i),c=injectInlineJs(o.resources.inlineScripts,c,e,i)):(c=injectJsWithPlaceHolder(u,c,e),c=injectCssWithPlaceHolder(p,c,e),c=cleanPlaceHolder(c)),s.setContent(c),s.useCache&&(e.pkg[s.subpath]=s)}})}};